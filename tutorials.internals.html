<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="TouchScript Internals">
        <meta name="author" content="Interactive Lab">
        <title>TouchScript</title>
        

        <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Droid+Sans:regular,bold|PT+Sans:400,700">
        <link rel="stylesheet" href="css/bootstrap.css">
        <link rel="stylesheet" href="css/main.css">

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-36698945-1']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();

        </script>
    </head>

    <body data-spy="scroll" data-target=".bs-docs-sidebar">
        <div class="container header">
            <ul>
                <li class="logo"><h2>TouchScript</h2></li>
                <li><a href="index.html">Home</a></li>
            </ul>
        </div>
        <div class="container page">
            <div class="row">
                <div class="span3 bs-docs-sidebar">
                    <ul class="nav nav-list bs-docs-sidenav">
                        <li><a href="#project"><i class="icon-chevron-right"></i> Project structure</a></li>
                        <li><a href="#touch"><i class="icon-chevron-right"></i> Touch journey</a></li>
                        <li><a href="#gesture"><i class="icon-chevron-right"></i> Custom gestures</a></li>
                    </ul>
                </div>
                <div class="span9">
                    <section>
                        <h2>TouchScript internals</h2>
                        <p>A deep explanation of how TouchScript works.</p>
                    </section>

                    <section id="project">
                        <h2>Project structure</h2>

                        <p>TouchScript consists of several projects which all compile into separate DLLs. Originally DLLs were chosen in the days of Unity 3.5 which didn't support namespaces. But now it's just easier to separate functionality so different DLLs could be used where appropriate.
                            <ul>
                                <li><strong>TouchScript</strong> — the main project which contains all cross-platform free/pro functionality.</li>
                                <li><strong>TouchScript.Editor</strong> — custom inspectors and editor extensions for TouchScript.</li>
                                <li><strong>TouchScript.Pro</strong> — scripts which are not supported in Unity3d Free, like <code>TuioInput</code> because it relies on sockets.</li>
                                <li><strong>TouchScript.Windows</strong> — Windows specific functionality which doesn't work or make sense on other platforms.</li>
                            </ul></p>
                        <p><span class="label label-important">NOTE:</span> if you want to build the library manually please note the following:</p>
                        <h5>Before building: Windows</h5>

                        <p>Copy <code>UnityEngine.dll</code> and <code>UnityEditor.dll</code> to <code>Lib</code> folder since the framework links to it.<br/>
                        They should be here: <code>c:\Program Files (x86)\Unity\Editor\Data\Managed\</code>.</p>
                        <h5>Before building: OS X</h5>
                        <p>Copy <code>UnityEngine.dll</code> and <code>UnityEditor.dll</code> to <code>Lib</code> folder.<br/>
                        They should be here: <code>/Applications/Unity/Unity.app/Contents/Frameworks/Managed/</code>.</p>
                        <p><strong>If anyone knows a better way of doing this without hardcoding paths or setting system variables, please let me know.</strong></p>
                    </section>

                    <section id="touch">
                        <h2>The journey of a touch point</h2>

                        <p>This section describes how a touch originated at user's finger gets to a gesture.<br/><br/></p>
                        <p><img src="img/tutorial-i/1.png"/><br/><br/><br/>
                        First a touch comes to an <strong>Input Source</strong>. It doesn't matter what touch-enabled device is used, it might be mouse or a fake touch generating script. All input sources have <code>CoordinatesRemapper</code> property which may contain an instance of <code>ICoordinatesRemapper</code>. In this case all touch points go through it before getting to <code>TouchManager</code>.</p>
                        <blockquote><em>Remappers are used when an input device isn't aligned to the screen correctly.<br/>
                            It might be necessary to rotate or scale data to match the screen.</em></blockquote>
                        <p><br/><img src="img/tutorial-i/2.png"/><br/><br/><br/>
                        Since many touch events can theoretically arrive between frames, <code>TouchManager</code> keeps them in buffers till the next <code>Update</code>. During the next <code>Update</code> all messages are processed and the following events are dispatched in the following order:
                        <ol>
                            <li><code>FrameStarted</code></li>
                            <li><code>TouchesBegan</code></li>
                            <li><code>TouchesMoved</code></li>
                            <li><code>TouchesEnded</code></li>
                            <li><code>TouchesCancelled</code></li>
                            <li><code>FrameFinished</code></li>
                        </ol>
                        </p>
                        <p><br/><img src="img/tutorial-i/3.png"/><br/><br/><br/>
                        Before dispatching <code>TouchesBegan</code> TouchManager goes through all instances of <code>TouchLayer</code> in the scene to determine if one of them wants to take the touch.</p> 
                        <p>The most used layer type is <code>CameraLayer</code>. It checks if a ray casted from camera's position hits any collider in the scene. If it does the system checks if there are any instances of <code>HitTest</code> attached to target object. They can intercept successful raycasts and modify them. For example <code>Untouchable</code> makes it impossible to touch an object.</p>
                        <p>Another layer type is <code>ScaleformLayer</code>. It transfers all touch points to ActionScript where Flash version of TouchScript gets them through <code>ScaleformInput</code>.</p>
                        <p>Layer which takes a touch sets its <code>Layer</code> and <code>Target</code> properties.</p>
                        <p><br/><img src="img/tutorial-i/4.png"/><br/><br/><br/>
                        When <code>Target</code> is determined, touch point goes to <code>GestureManager</code> with <code>TouchesBegan</code> event. <code>Gesturemanager</code> checks if any gesture on the target or in its transform hierarchy is interested in this touch. This process is a bit tricky.</p>
                        <p><br/><img src="img/tutorial-i/5.png"/><br/><br/><br/>
                        For example we have an interface shown on the image above with nested boxes. When user touches box <code>E</code> the system looks for all the gestures on boxes from the root object to the <code>Target</code> which are able to receive touch points (in this case boxes <code>E</code>, <code>C</code> and <code>A</code>). If there's no active gesture in the graph containing the <code>Target</code> all gestures get the touch until one of them changes its state to <code>Recognized</code> or <code>Began</code>.</p>
                        <p>So, let's assume that some gesture on box <code>E</code> got this touch point and started. It now owns this touch point and all other gestures in the graph which are not <strong>friendly</strong> to this gesture and returned <code>true</code> from <code>CanBePreventedByGesture(gesture)</code> will be forced to fail and reset.</p>
                        <p><br/><img src="img/tutorial-i/6.png"/><br/><br/><br/>
                        Now user touches box <code>C</code> which is a parent container of box <code>E</code>. The system once again grabs all gestures on yellow boxes but checks them against all the gestures on green boxes. In this case a gesture on box <code>E</code> is active and prevents all gestures starting from <code>C</code> and up from beginning.</p>
                        <p>To make gestures in hierarchy work together we need to add one to another's <code>Friendly gestures</code> property in inspector or via <code>AddFriendlyGesture(gesture)</code> method. If gestures are friendly they can share owned touch points.</p>
                        <p>When <code>TouchesMoved</code>, <code>TouchesEnded</code> or <code>TouchesCancelled</code> events occur the process is much simpler since only gestures which own touch points from an event will be notified.</p>
                        <p>So, that's how a touch point goes all the way from an input device to gestures.</p>
                    </section>

                    <section id="gesture">
                        <h2>Writing a custom gesture</h2>

                        <p>In <strong>TouchScript</strong> only gestures can receive touch events. The library comes with several prebuilt gestures which handle most of the cases but sometimes it's just easier to write a new one than try to combine them. This knowledge also is useful for better understanding how the library works.</p>
                        <p>Gestures can be one of the two types:
                            <ul>
                                <li><strong>Discrete</strong> gestures immediately reset after recognized (tap, press),</li>
                                <li><strong>Continuous</strong> gestures when recognized start sending incremental updates (pan, scale).</li>
                            </ul></p>

                        <h3>States</h3>
                        <p>A gesture is a state machine. It can be in one of the following states:
                            <ul>
                                <li><code>Possible</code> - gesture needs more information/time to either transition to <code>Recognized</code> or <code>Failed</code>,</li>
                                <li><code>Began</code> - when a continuous gesture starts it transitions to Began state,</li>
                                <li><code>Changed</code> - continuous gestures keep going to Changed state in a loop to update their values,</li>
                                <li><code>Recognized</code> - when recognized a discrete gesture transitions to Recognized state and resets,</li>
                                <li><code>Ended</code> - same as Recognized but for continuous gestures,</li>
                                <li><code>Failed</code> - gesture couldn't recognize a touch sequence,</li>
                                <li><code>Cancelled</code> - gesture was cancelled and should abort.</li>
                            </ul></p>

                        <p>All gestures inherit from <code>Gesture</code> class which provides several callbacks to override.</p>
                        <pre class="prettyprint linenums lang-csh">
protected virtual void touchesBegan(IList<TouchPoint> touches) {}
protected virtual void touchesMoved(IList<TouchPoint> touches) {}
protected virtual void touchesEnded(IList<TouchPoint> touches) {}
protected virtual void touchesCancelled(IList<TouchPoint> touches) {}
protected virtual void reset() {}</pre>
                        <p>The first 4 callbacks are called by <code>GestureManager</code> when touch events occur associated with target gesture. <code>reset</code> is called after gesture transitioned to <code>Recognized</code>, <code>Failed</code> or <code>Cancelled</code> state which resets it to <code>Possible</code> again.</p>
                        <p>To change gesture's state in code you should call <code>setState(GestureState value)</code>.</p>
                        <p>Please check out on GitHub how <a href="https://github.com/InteractiveLab/TouchScript/tree/master/TouchScript/Gestures">built-in gestures</a> are implemented. For example <a href="https://github.com/InteractiveLab/TouchScript/blob/master/TouchScript/Gestures/TapGesture.cs">TapGesture</a>.</p>
                    </section>

                </div>
            </div>
            <div class="footer"><a href="https://github.com/InteractiveLab/TouchScript">TouchScript</a> — multitouch framework for Unity3d and Flash. Copyright (c) 2013 Valentin Simonov, Interactive Lab.</div>
        </div>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script type="text/javascript" src="js/bootstrap.min.js"></script>
        <script type="text/javascript" src="js/prettify.js"></script>
        <script type="text/javascript">
            !function ($) {
              $(function(){
                var $window = $(window)

                // make code pretty
                window.prettyPrint && prettyPrint()

                // side bar
                $('.bs-docs-sidenav').affix({
                  offset: {
                    top: function () { return $window.width() <= 980 ? 150 : 150 }
                  , bottom: 270
                  }
                })

                // carousel
                $('.carousel').carousel({
                    interval: 5000,
                    pause: "hover"
                })

              })
            }(window.jQuery)

        </script>
    </body>
</html>
